<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Momentum Control Panel</title>
  <style>
    :root {
      --bg: #0c111d;
      --panel: rgba(255,255,255,0.06);
      --panel-border: rgba(255,255,255,0.08);
      --text: #e8ecf5;
      --muted: #9aa5c4;
      --accent: #6f8bff;
      --accent-2: #c084fc;
      --badge-ok: #22c55e;
      --badge-warn: #f97316;
      --badge-err: #ef4444;
      --card-radius: 14px;
      --shadow: 0 12px 40px rgba(0,0,0,0.35);
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: "Inter", "SF Pro Text", system-ui, -apple-system, sans-serif;
      background: radial-gradient(circle at 20% 20%, rgba(111,139,255,0.16), transparent 35%),
                  radial-gradient(circle at 80% 0%, rgba(192,132,252,0.18), transparent 30%),
                  var(--bg);
      color: var(--text);
    }
    h1 { margin: 0 0 6px 0; font-size: 28px; }
    .subtitle { color: var(--muted); margin: 0 0 20px 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 16px; }
    .card {
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: var(--card-radius);
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(6px);
    }
    .card h3 { margin: 0 0 6px 0; }
    .muted { color: var(--muted); font-size: 13px; }
    .script-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 14px; margin-bottom: 20px; }
    .arg { margin-bottom: 8px; }
    .arg label { display: block; font-size: 12px; color: var(--muted); margin-bottom: 4px; }
    .arg input { width: 100%; padding: 8px 10px; border-radius: 10px; border: 1px solid var(--panel-border); background: rgba(255,255,255,0.04); color: var(--text); }
    button {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: #0b1020;
      border: none;
      border-radius: 10px;
      padding: 9px 12px;
      cursor: pointer;
      font-weight: 700;
      box-shadow: 0 8px 20px rgba(111,139,255,0.35);
    }
    button:hover { transform: translateY(-1px); }
    button:active { transform: translateY(0); }
    .jobs { max-height: 320px; overflow-y: auto; }
    .job { padding: 10px 0; border-bottom: 1px solid var(--panel-border); }
    .badge { display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .status-running { background: rgba(249,115,22,0.15); color: #fb923c; }
    .status-completed { background: rgba(34,197,94,0.15); color: var(--badge-ok); }
    .status-failed, .status-error { background: rgba(239,68,68,0.15); color: var(--badge-err); }
    .status-queued { background: rgba(111,139,255,0.15); color: var(--accent); }
    pre { background: #0b1020; color: #e5e7eb; padding: 12px; border-radius: 10px; max-height: 320px; overflow: auto; font-size: 13px; }
    a { color: var(--accent); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .links { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; }
    .pill { display: inline-block; padding: 4px 10px; border-radius: 999px; background: rgba(255,255,255,0.06); border: 1px solid var(--panel-border); font-size: 12px; color: var(--muted); }
    .cmd-line { font-family: "JetBrains Mono", "SFMono-Regular", monospace; font-size: 12px; color: var(--muted); margin-top: 6px; white-space: pre-wrap; }
  </style>
</head>
<body>
  <h1>Momentum Control Panel</h1>
  <p class="subtitle">Launch scripts, review jobs, and jump to reports. Styled with the new design ideas palette.</p>

  <div class="card">
    <h3>Scripts</h3>
    <p class="muted" style="margin-bottom:10px;">Each card mirrors a CLI script. Fill args (or leave defaults) and run.</p>
    <div class="script-grid" id="command-grid"></div>
  </div>

  <div class="grid">
    <div class="card">
      <div style="display:flex; justify-content: space-between; align-items:center;">
        <div>
          <h3 style="margin:0;">Job Activity</h3>
          <div class="muted">Recent runs with timestamps and args.</div>
        </div>
        <button id="refresh-jobs">Refresh</button>
      </div>
      <div class="jobs" id="jobs"></div>
    </div>

    <div class="card">
      <div style="display:flex; justify-content: space-between; align-items:center;">
        <div>
          <h3 style="margin:0;">Logs</h3>
          <div class="muted">Pick a job to view its output.</div>
        </div>
        <select id="log-select" style="padding:8px; border-radius:8px; border:1px solid var(--panel-border); background: rgba(255,255,255,0.04); color: var(--text);"></select>
      </div>
      <pre id="log-viewer">Select a job to view logs.</pre>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 6px 0;">Quick Links</h3>
    <div class="links">
      <a href="/data/backtests/report.html" target="_blank" class="pill">Latest Backtest Report</a>
      <a href="/experiments" target="_blank" class="pill">Experiments Folder</a>
      <a href="/data/momentum/top25_signals.csv" target="_blank" class="pill">Momentum Signals CSV</a>
      <a href="/data/benchmarks/nifty100.csv" target="_blank" class="pill">Benchmark Series</a>
      <a href="/data/backtests" target="_blank" class="pill">Backtest Outputs</a>
    </div>
  </div>

  <script>
    let commands = [];

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      return res.json();
    }

    async function loadCommands() {
      const data = await fetchJSON('/api/commands');
      commands = data.commands;
      const grid = document.getElementById('command-grid');
      grid.innerHTML = '';
      commands.forEach(cmd => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <div style="display:flex; justify-content: space-between; align-items:center; gap:8px; margin-bottom:6px;">
            <div>
              <div class="pill" style="margin-bottom:6px;">${cmd.key}</div>
              <h3 style="margin:0;">${cmd.label}</h3>
              <div class="muted">${cmd.description}</div>
            </div>
            <button data-cmd="${cmd.key}">Run</button>
          </div>
          <div class="args"></div>
          <div class="cmd-line">${cmd.cmd}</div>
        `;
        const argsDiv = card.querySelector('.args');
        (cmd.args || []).forEach(arg => {
          const wrap = document.createElement('div');
          wrap.className = 'arg';
          wrap.innerHTML = `
            <label>${arg.flag} — ${arg.help}</label>
            <input type="text" data-flag="${arg.flag}" value="${arg.placeholder || ''}">
          `;
          argsDiv.appendChild(wrap);
        });
        card.querySelector('button').addEventListener('click', () => {
          const args = [];
          (cmd.args || []).forEach(arg => {
            const input = card.querySelector(`input[data-flag="${arg.flag}"]`);
            const val = (input.value || '').trim();
            if (!val) return;
            const parts = val.split(/\s+/).filter(Boolean);
            args.push(arg.flag, ...parts);
          });
          startJob(cmd.key, args);
        });
        grid.appendChild(card);
      });
    }

    async function startJob(command, args=[]) {
      await fetchJSON('/api/jobs', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command, args})
      });
      loadJobs();
    }

    function statusBadge(status) {
      const base = status.split(' ')[0];
      const cls = {
        queued: 'status-queued',
        running: 'status-running',
        completed: 'status-completed',
      }[base] || (status.startsWith('failed') || status.startsWith('error') ? 'status-failed' : 'status-queued');
      return `<span class="badge ${cls}">${status}</span>`;
    }

    async function loadJobs() {
      const data = await fetchJSON('/api/jobs');
      const jobsDiv = document.getElementById('jobs');
      const select = document.getElementById('log-select');
      jobsDiv.innerHTML = '';
      select.innerHTML = '<option value=\"\">Select job...</option>';
      data.jobs.slice().reverse().forEach(job => {
        const div = document.createElement('div');
        div.className = 'job';
        div.innerHTML = `
          <div class="flex" style="justify-content: space-between;">
            <div><strong>${job.label}</strong> (${job.command})</div>
            <div>${statusBadge(job.status)}</div>
          </div>
          <div style="font-size:12px; color:#6b7280;">${job.started_at || '-'} → ${job.ended_at || ''}</div>
          <div style="font-size:12px; color:#6b7280;">Args: ${job.args.join(' ') || '(default)'}</div>
          <div style="font-size:12px; color:#6b7280;">Log: ${job.id}.log</div>
        `;
        jobsDiv.appendChild(div);
        select.insertAdjacentHTML('beforeend', `<option value="${job.id}">${job.id} — ${job.label}</option>`);
      });
    }

    async function loadLog(id) {
      if (!id) return;
      const data = await fetchJSON(`/api/logs/${id}`);
      document.getElementById('log-viewer').textContent = data.content || 'No log content';
    }

    document.getElementById('refresh-jobs').addEventListener('click', loadJobs);
    document.getElementById('log-select').addEventListener('change', (e) => loadLog(e.target.value));

    loadCommands();
    loadJobs();
    setInterval(loadJobs, 8000);
  </script>
</body>
</html>
