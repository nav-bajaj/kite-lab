<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Momentum Control Panel</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f5f7fb; color: #1f2d3d; }
    h1 { margin-bottom: 4px; }
    .subtitle { color: #4b5563; margin-top: 0; }
    .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-bottom: 16px; }
    .card { background: #fff; border: 1px solid #e5e7eb; border-radius: 8px; padding: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
    button { background: #2563eb; color: #fff; border: none; border-radius: 6px; padding: 8px 10px; cursor: pointer; font-weight: 600; }
    button:hover { background: #1d4ed8; }
    button:disabled { background: #9ca3af; cursor: not-allowed; }
    .jobs { max-height: 300px; overflow-y: auto; }
    .job { padding: 8px; border-bottom: 1px solid #e5e7eb; }
    .job:last-child { border-bottom: none; }
    .badge { display: inline-block; padding: 2px 8px; border-radius: 999px; font-size: 12px; font-weight: 700; }
    .status-running { background: #fff7ed; color: #c2410c; }
    .status-completed { background: #ecfdf3; color: #15803d; }
    .status-failed, .status-error { background: #fef2f2; color: #b91c1c; }
    .status-queued { background: #e0f2fe; color: #0369a1; }
    pre { background: #0b1220; color: #e5e7eb; padding: 12px; border-radius: 8px; max-height: 320px; overflow: auto; font-size: 13px; }
    .flex { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }
    a { color: #2563eb; text-decoration: none; }
    a:hover { text-decoration: underline; }
    .links { display: flex; gap: 10px; flex-wrap: wrap; }
  </style>
</head>
<body>
  <h1>Momentum Control Panel</h1>
  <p class="subtitle">Run daily tasks, build signals, and generate reports from one page.</p>

  <div class="card">
    <h3 style="margin:0 0 8px 0;">Run a Script</h3>
    <div class="flex" style="gap:12px; align-items:flex-start;">
      <div>
        <label style="font-size:12px; color:#4b5563;">Select script</label><br>
        <select id="command-select" style="min-width:240px; padding:6px; border:1px solid #e5e7eb; border-radius:6px;"></select>
      </div>
      <div style="flex:1;">
        <div id="command-desc" style="color:#4b5563; margin-bottom:8px;"></div>
        <div id="args-form"></div>
        <button id="run-btn">Run</button>
        <div id="cmd-preview" style="margin-top:6px; font-size:12px; color:#6b7280;"></div>
      </div>
    </div>
  </div>

  <div class="grid">
    <div class="card">
      <div class="flex" style="justify-content: space-between;">
        <h3 style="margin:0;">Job Activity</h3>
        <button id="refresh-jobs">Refresh</button>
      </div>
      <div class="jobs" id="jobs"></div>
    </div>

    <div class="card">
      <div class="flex" style="justify-content: space-between;">
        <h3 style="margin:0;">Logs</h3>
        <select id="log-select"></select>
      </div>
      <pre id="log-viewer">Select a job to view logs.</pre>
    </div>
  </div>

  <div class="card">
    <h3 style="margin:0;">Reports & Data</h3>
    <div class="links">
      <a href="/data/backtests/report.html" target="_blank">Latest Backtest Report (if present)</a>
      <a href="/experiments" target="_blank">Experiments folder</a>
      <a href="/data/momentum/top25_signals.csv" target="_blank">Momentum Signals</a>
      <a href="/data/benchmarks/nifty100.csv" target="_blank">Benchmark Series</a>
      <a href="/data/backtests" target="_blank">Backtest outputs folder</a>
    </div>
  </div>

  <script>
    let commands = [];

    async function fetchJSON(url, opts) {
      const res = await fetch(url, opts);
      return res.json();
    }

    async function loadCommands() {
      const data = await fetchJSON('/api/commands');
      commands = data.commands;
      const select = document.getElementById('command-select');
      select.innerHTML = '';
      commands.forEach(cmd => {
        const opt = document.createElement('option');
        opt.value = cmd.key;
        opt.textContent = cmd.label;
        select.appendChild(opt);
      });
      select.addEventListener('change', () => renderCommand(select.value));
      renderCommand(commands[0]?.key);
    }

    function renderCommand(key) {
      const cmd = commands.find(c => c.key === key);
      if (!cmd) return;
      document.getElementById('command-desc').textContent = cmd.description;
      document.getElementById('cmd-preview').textContent = cmd.cmd;
      const form = document.getElementById('args-form');
      form.innerHTML = '';
      (cmd.args || []).forEach(arg => {
        const wrapper = document.createElement('div');
        wrapper.style.marginBottom = '6px';
        wrapper.innerHTML = `
          <label style="display:block; font-size:12px; color:#4b5563; margin-bottom:2px;">
            ${arg.flag} — ${arg.help}
          </label>
          <input type="text" data-flag="${arg.flag}" value="${arg.placeholder || ''}" style="width:100%; padding:6px; border:1px solid #e5e7eb; border-radius:6px;">
        `;
        form.appendChild(wrapper);
      });
      document.getElementById('run-btn').onclick = () => {
        const args = [];
        (cmd.args || []).forEach(arg => {
          const input = form.querySelector(`input[data-flag="${arg.flag}"]`);
          const val = (input.value || "").trim();
          if (!val) return;
          const parts = val.split(/\s+/).filter(Boolean);
          args.push(arg.flag, ...parts);
        });
        startJob(cmd.key, args);
      };
    }

    async function startJob(command, args=[]) {
      await fetchJSON('/api/jobs', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({command, args})
      });
      loadJobs();
    }

    function statusBadge(status) {
      const base = status.split(' ')[0];
      const cls = {
        queued: 'status-queued',
        running: 'status-running',
        completed: 'status-completed',
      }[base] || (status.startsWith('failed') || status.startsWith('error') ? 'status-failed' : 'status-queued');
      return `<span class="badge ${cls}">${status}</span>`;
    }

    async function loadJobs() {
      const data = await fetchJSON('/api/jobs');
      const jobsDiv = document.getElementById('jobs');
      const select = document.getElementById('log-select');
      jobsDiv.innerHTML = '';
      select.innerHTML = '<option value=\"\">Select job...</option>';
      data.jobs.slice().reverse().forEach(job => {
        const div = document.createElement('div');
        div.className = 'job';
        div.innerHTML = `
          <div class="flex" style="justify-content: space-between;">
            <div><strong>${job.label}</strong> (${job.command})</div>
            <div>${statusBadge(job.status)}</div>
          </div>
          <div style="font-size:12px; color:#6b7280;">${job.started_at || '-'} → ${job.ended_at || ''}</div>
          <div style="font-size:12px; color:#6b7280;">Args: ${job.args.join(' ') || '(default)'}</div>
          <div style="font-size:12px; color:#6b7280;">Log: ${job.id}.log</div>
        `;
        jobsDiv.appendChild(div);
        select.insertAdjacentHTML('beforeend', `<option value="${job.id}">${job.id} — ${job.label}</option>`);
      });
    }

    async function loadLog(id) {
      if (!id) return;
      const data = await fetchJSON(`/api/logs/${id}`);
      document.getElementById('log-viewer').textContent = data.content || 'No log content';
    }

    document.getElementById('refresh-jobs').addEventListener('click', loadJobs);
    document.getElementById('log-select').addEventListener('change', (e) => loadLog(e.target.value));

    loadCommands();
    loadJobs();
    setInterval(loadJobs, 8000);
  </script>
</body>
</html>
